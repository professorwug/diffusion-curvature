<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>diffusion_curvature - Mapping the Data to a Flat Space with Continuous Normalizing Flows</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="diffusion_curvature - Mapping the Data to a Flat Space with Continuous Normalizing Flows">
<meta property="og:description" content="">
<meta property="og:image" content="https://professorwug.github.io/diffusion_curvature/library/continuous_normalizing_flows_files/figure-html/cell-6-output-1.png">
<meta property="og:site-name" content="diffusion_curvature">
<meta property="og:image:height" content="790">
<meta property="og:image:width" content="790">
<meta name="twitter:title" content="diffusion_curvature - Mapping the Data to a Flat Space with Continuous Normalizing Flows">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://professorwug.github.io/diffusion_curvature/library/continuous_normalizing_flows_files/figure-html/cell-6-output-1.png">
<meta name="twitter:image-height" content="790">
<meta name="twitter:image-width" content="790">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">diffusion_curvature</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/professorwug/diffusion_curvature" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../library/Comparison Space Construction.html">library</a></li><li class="breadcrumb-item"><a href="../library/continuous_normalizing_flows.html">Mapping the Data to a Flat Space with Continuous Normalizing Flows</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Curvature</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a Visual Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a A Visual Battery of Benchmarks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a1 DC of Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a1 Computing the diffusion curvature of the battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a1a DC of LowD High Sample Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a1a Computing the diffusion curvature of the battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a2 Hickok Curvature of Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a2 Hickok Curvature of Battery.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3b Hickok Comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3b Hickok Comparison.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3c Sampling Experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3c Sampling Experiments on Diffusion Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3d Detecting Negative Curvature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3d Detecting Negative Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3d1 Effects of Graph Construction on Negative Curvature Detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3d1 Effects of Graph Construction on Negative Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e Curvature with (Neural) Flattening.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e Curvature Via (Neural) Flattening</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e1 Flattening with Diffusion Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e1 Flattening with Diffusion Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e2 Neural Flattening with Gromov Wasserstein.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e2 Neural Flattening with Gromov Wasserstein</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Curvature by Quadratic Fitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scalar Curvature by Volume Comparison</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Diffusion Laziness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Measurements of Diffusion Laziness</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Examples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Explorations in Lazy-first diffusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explorations in Lazy-first Diffusion Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Neumann Heat Kernel via Chebyshev Approximation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analytic estimation of the heat kernel</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">library</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Comparison Space Construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comparison Space Construction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Construct Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a Construct Battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Core.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implementation (PyGSP + JAX)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Curvature Enhanced Spectral Clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1d Curvature Clustering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Entropy for Optimal t.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Entropy for Optimal t.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Laziness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Laziness Estimators</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Ricci Curvature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Ricci Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graph Creation Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Heat Diffusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Heat Diffusion</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Kernels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kernels</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Manifold Distances.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Manifold Distances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Mean Flat Entropies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1c1 Mean Entropy of Uniform Flat Spaces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Random Surfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Surfaces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Volume Estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Volume Estimation with Heat Diffusion</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/continuous_normalizing_flows.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Mapping the Data to a Flat Space with Continuous Normalizing Flows</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#defining-a-neural-ode" id="toc-defining-a-neural-ode" class="nav-link active" data-scroll-target="#defining-a-neural-ode">Defining a Neural ODE</a>
  <ul>
  <li><a href="#dealing-with-data" id="toc-dealing-with-data" class="nav-link" data-scroll-target="#dealing-with-data">Dealing with Data</a></li>
  <li><a href="#manifoldneighborhooddataset" id="toc-manifoldneighborhooddataset" class="nav-link" data-scroll-target="#manifoldneighborhooddataset">ManifoldNeighborhoodDataset</a></li>
  <li><a href="#dataloader_from_manifold_neighborhoods" id="toc-dataloader_from_manifold_neighborhoods" class="nav-link" data-scroll-target="#dataloader_from_manifold_neighborhoods">dataloader_from_manifold_neighborhoods</a></li>
  <li><a href="#neighborhoods-of-the-torus" id="toc-neighborhoods-of-the-torus" class="nav-link" data-scroll-target="#neighborhoods-of-the-torus">Neighborhoods of the Torus</a></li>
  <li><a href="#datasets-for-testing" id="toc-datasets-for-testing" class="nav-link" data-scroll-target="#datasets-for-testing">Datasets for testing</a></li>
  </ul></li>
  <li><a href="#neural-ode-machinery" id="toc-neural-ode-machinery" class="nav-link" data-scroll-target="#neural-ode-machinery">Neural ODE Machinery</a>
  <ul>
  <li><a href="#flownet" id="toc-flownet" class="nav-link" data-scroll-target="#flownet">FlowNet</a></li>
  <li><a href="#negativeloglikelihoodquauniform" id="toc-negativeloglikelihoodquauniform" class="nav-link" data-scroll-target="#negativeloglikelihoodquauniform">NegativeLogLikelihoodQuaUniform</a></li>
  <li><a href="#negativeloglikelihood" id="toc-negativeloglikelihood" class="nav-link" data-scroll-target="#negativeloglikelihood">NegativeLogLikelihood</a></li>
  <li><a href="#greatflattener" id="toc-greatflattener" class="nav-link" data-scroll-target="#greatflattener">GreatFlattener</a></li>
  </ul></li>
  <li><a href="#training-on-a-toy-dataset" id="toc-training-on-a-toy-dataset" class="nav-link" data-scroll-target="#training-on-a-toy-dataset">Training on a Toy Dataset</a></li>
  <li><a href="#an-sklearn-like-interface-to-the-node" id="toc-an-sklearn-like-interface-to-the-node" class="nav-link" data-scroll-target="#an-sklearn-like-interface-to-the-node">An sklearn like interface to the nODE</a>
  <ul>
  <li><a href="#neural_flattener" id="toc-neural_flattener" class="nav-link" data-scroll-target="#neural_flattener">neural_flattener</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/professorwug/diffusion_curvature/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Mapping the Data to a Flat Space with Continuous Normalizing Flows</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>Previously, our diffusion curvature comparison was done using a uniform sampling of a flat space. There’s some variance here, due to random sampling, which is not ideal – it mirrors the variance in sampling of the dataset itself, but compounds upon the problem by using a <em>different</em> random sampling. We observed that, with low-dimensional abundantly sampled data (like our torus), this variance was over 10x smaller than the variance within the torus, making comparisons possible. But for more sparsely sampled data (including, by necessity, all high dimensional data), the variance due to sampling will be much greater. This raises the question: <strong>can we learn a flat space with a sampling equivalent to the manifold’s sampling?</strong></p>
<p>It’s not obvious that this question makes sense. What does it mean for a plane to be sampled the same as a sphere? Both can be uniformly sampled with respect to volume, but volume is modulated by curvature. Considering any sufficiently large neighborhood of the sphere versus an equivalent neighborhood of the plane, the neighborhood in positive curvature will have fewer points, because it has less volume. It’s impossible to place a sticker on a tennis ball; the flat sticker has “too many points” to biject onto the ball.</p>
<p>However, at a sufficiently small neighborhood size, the question starts to make sense. It mirrors the aspiration to learn a logarithmic (or reverse-exponential) map, from the manifold to its tangent space. Equipped with this map, or a good approximation, we might be able to obtain a flat space with a (locally accurate) one-to-one mapping between points in the flat space and on the manifold.</p>
<p>This could be useful in a couple of ways: 1. Performing diffusion entropy in the equivalently sampled flat space. If a neighborhood of the manifold is sparsely sampled, it will bias the diffusion entropy towards being more negative than reality. If we create a flat space with a similarly sparse sampling, and a similarly biased entropy, the biases will cancel each other out in comparison. 2. If the map is a <em>really</em> good approximation of the logarithmic map, we could discern curvature just by locally measuring the changes in distances between points. This would put our bijection between points in the flat and manifold spaces to much better use, but it requires much more from the continuous normalizing flows.</p>
<p>The key challenges we anticipate include: 1. Mapping a sufficient number of points to perform 4-8 scales of diffusion may involve a neighborhood so large that the global geometry interferes with the sampling. For example, if mapping a 500 point neighborhood from the sphere into a flat space, these 500 points might include enough of the sphere’s curvature that the flat space appears more sparsely sampled than the sphere, thus biasing the comparison space. (Interestingly, though, this bias could be used to measure the curvature…)</p>
<p>Here’s the strategy: for every point <span class="math inline">\(x_i\)</span>, we’ll take the nearest <span class="math inline">\(n\)</span> points on the manifold, and treat this neighborhood of curvature like a self-contained dataset. We’ll then learn a continuous normalizing flow from this neighborhood of curvature to a uniformly sampled flat space of a supplied dimension. We’ll perform diffusion entropy in both spaces, bearing in mind these caveats: - <span class="math inline">\(k\)</span> must be sufficiently large to minimize edge effects, where the diffusion, instead of continuing across the manifold, rebounds on itself. - <span class="math inline">\(k\)</span> must be sufficiently small to avoid the mixing of geometry and sampling.</p>
<section id="defining-a-neural-ode" class="level1">
<h1>Defining a Neural ODE</h1>
<p>This code is adapted from Sumner Magruder’s Neural ODE implementation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch, torch.nn <span class="im">as</span> nn, torch.utils.data <span class="im">as</span> data, torch.nn.functional <span class="im">as</span> F, torch.optim <span class="im">as</span> optim</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ot</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.core <span class="im">import</span> NeuralODE</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.datasets <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytorch_lightning <span class="im">as</span> pl</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.autonotebook <span class="im">import</span> tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/piriac/mambaforge/envs/diffusion_curvature/lib/python3.11/site-packages/ot/backend.py:1368: UserWarning: Explicitly requested dtype &lt;class 'jax.numpy.float64'&gt; requested in array is not available, and will be truncated to dtype float32. To enable more dtypes, set the jax_enable_x64 configuration option or the JAX_ENABLE_X64 shell environment variable. See https://github.com/google/jax#current-gotchas for more.
  jax.device_put(jnp.array(1, dtype=jnp.float64), d)</code></pre>
</div>
</div>
<section id="dealing-with-data" class="level3">
<h3 class="anchored" data-anchor-id="dealing-with-data">Dealing with Data</h3>
<p>In standard nODE training, we use minibatches of points sampled from the entire dataset. In our case, we’re only training <em>locally</em>, on the neighborhood of a point. Hence, the dataset will be a fixed number of points, operated without any fancy batching.</p>
<hr>
</section>
<section id="manifoldneighborhooddataset" class="level3">
<h3 class="anchored" data-anchor-id="manifoldneighborhooddataset">ManifoldNeighborhoodDataset</h3>
<blockquote class="blockquote">
<pre><code> ManifoldNeighborhoodDataset (X, n_neighbors, intrinsic_dimension)</code></pre>
</blockquote>
<p>An abstract class representing a :class:<code>Dataset</code>.</p>
<p>All datasets that represent a map from keys to data samples should subclass it. All subclasses should overwrite :meth:<code>__getitem__</code>, supporting fetching a data sample for a given key. Subclasses could also optionally overwrite :meth:<code>__len__</code>, which is expected to return the size of the dataset by many :class:<code>~torch.utils.data.Sampler</code> implementations and the default options of :class:<code>~torch.utils.data.DataLoader</code>.</p>
<p>.. note:: :class:<code>~torch.utils.data.DataLoader</code> by default constructs a index sampler that yields integral indices. To make it work with a map-style dataset with non-integral indices/keys, a custom sampler must be provided.</p>
<hr>
</section>
<section id="dataloader_from_manifold_neighborhoods" class="level3">
<h3 class="anchored" data-anchor-id="dataloader_from_manifold_neighborhoods">dataloader_from_manifold_neighborhoods</h3>
<blockquote class="blockquote">
<pre><code> dataloader_from_manifold_neighborhoods (X, n_neighbors)</code></pre>
</blockquote>
</section>
<section id="neighborhoods-of-the-torus" class="level3">
<h3 class="anchored" data-anchor-id="neighborhoods-of-the-torus">Neighborhoods of the Torus</h3>
<p>Visualizations to help select an appropriate number of points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>X_torus, ks_torus <span class="op">=</span> torus(n <span class="op">=</span> <span class="dv">4000</span>, use_guide_points<span class="op">=</span><span class="va">False</span>) <span class="co"># </span><span class="al">TODO</span><span class="co">: Fix rejection sampling and so we actually get n_points = n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-6-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>n_neighbors <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>torus_dataset <span class="op">=</span> ManifoldNeighborhoodDataset(X_torus, intrinsic_dimension<span class="op">=</span><span class="dv">2</span>, n_neighbors<span class="op">=</span>n_neighbors)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>torus_dataloader <span class="op">=</span> data.DataLoader(torus_dataset, batch_size<span class="op">=</span><span class="va">None</span>,shuffle<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>torus_nbhd, pca_torus_nbhd <span class="op">=</span> torus_dataset.<span class="fu">__getitem__</span>(np.random.randint(<span class="bu">len</span>(X_torus)))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>plot_3d(torus_nbhd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(pca_torus_nbhd[:,<span class="dv">0</span>],pca_torus_nbhd[:,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.collections.PathCollection&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-9-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="datasets-for-testing" class="level2">
<h2 class="anchored" data-anchor-id="datasets-for-testing">Datasets for testing</h2>
<p>This dataset returns the whole torus.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>whole_torus_dataset <span class="op">=</span> data.TensorDataset(torch.tensor(X_torus).<span class="bu">float</span>())</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>whole_torus_dataloader <span class="op">=</span> data.DataLoader(whole_torus_dataset, batch_size<span class="op">=</span><span class="bu">len</span>(X_torus), shuffle<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a toy dataset from the torch dyn library:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.datasets <span class="im">import</span> <span class="op">*</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.utils.data <span class="im">as</span> data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> ToyDataset()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>X_moons, yn_moons <span class="op">=</span> d.generate(n_samples<span class="op">=</span><span class="dv">512</span>, noise<span class="op">=</span><span class="fl">1e-1</span>, dataset_type<span class="op">=</span><span class="st">'moons'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> MinMaxScaler(feature_range<span class="op">=</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>X_moons <span class="op">=</span> scaler.fit_transform(X_moons)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'orange'</span>, <span class="st">'blue'</span>]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X_moons)):</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    ax.scatter(X_moons[i,<span class="dv">0</span>], X_moons[i,<span class="dv">1</span>], s<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span>colors[yn_moons[i].<span class="bu">int</span>()])</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> torch.Tensor(X_moons)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>moons_trainset <span class="op">=</span> data.TensorDataset(X_train)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>moons_trainloader <span class="op">=</span> data.DataLoader(moons_trainset, batch_size<span class="op">=</span><span class="bu">len</span>(X_moons), shuffle<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-12-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="neural-ode-machinery" class="level1">
<h1>Neural ODE Machinery</h1>
<hr>
<section id="flownet" class="level3">
<h3 class="anchored" data-anchor-id="flownet">FlowNet</h3>
<blockquote class="blockquote">
<pre><code> FlowNet (dimension, activation='CELU')</code></pre>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.linspace(<span class="op">-</span><span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">100</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ys <span class="op">=</span> torch.sigmoid(<span class="dv">100</span><span class="op">*</span>(<span class="op">-</span>x<span class="op">+</span><span class="fl">0.9</span>))<span class="op">*</span>torch.sigmoid(<span class="dv">100</span><span class="op">*</span>(x<span class="op">+</span><span class="fl">0.9</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x,ys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
<hr>
</section>
<section id="negativeloglikelihoodquauniform" class="level3">
<h3 class="anchored" data-anchor-id="negativeloglikelihoodquauniform">NegativeLogLikelihoodQuaUniform</h3>
<blockquote class="blockquote">
<pre><code> NegativeLogLikelihoodQuaUniform (model:torch.nn.modules.module.Module)</code></pre>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool</p>
<hr>
</section>
<section id="negativeloglikelihood" class="level3">
<h3 class="anchored" data-anchor-id="negativeloglikelihood">NegativeLogLikelihood</h3>
<blockquote class="blockquote">
<pre><code> NegativeLogLikelihood (model:torch.nn.modules.module.Module)</code></pre>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in a tree structure. You can assign the submodules as regular attributes::</p>
<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))</code></pre>
<p>Submodules assigned in this way will be registered, and will have their parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>.. note:: As per the example above, an <code>__init__()</code> call to the parent class must be made before assignment on the child.</p>
<p>:ivar training: Boolean represents whether this module is in training or evaluation mode. :vartype training: bool</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">10</span>,<span class="dv">2</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">sum</span>(A,dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([0.7195, 1.3977, 0.6225, 1.7919, 1.0505, 0.3961, 1.4624, 1.6844, 0.4154,
        1.0866])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>torch.log(torch.ones(<span class="dv">4</span>)<span class="op">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-0.6931, -0.6931, -0.6931, -0.6931])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span>  DeviationFromFlatness(nn.Module):    </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model:nn.Module):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model    </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, X:torch.Tensor, prior):          </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>        transformed <span class="op">=</span> <span class="va">self</span>.model(X)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytorch_lightning <span class="im">as</span> pl</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.nn <span class="im">import</span> Augmenter</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.models <span class="im">import</span> CNF</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="greatflattener" class="level3">
<h3 class="anchored" data-anchor-id="greatflattener">GreatFlattener</h3>
<blockquote class="blockquote">
<pre><code> GreatFlattener (model:torch.nn.modules.module.Module, input_dim:int,
                 target_dim:int, device)</code></pre>
</blockquote>
<p>Hooks to be used in LightningModule.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>model</td>
<td>Module</td>
<td></td>
</tr>
<tr class="even">
<td>input_dim</td>
<td>int</td>
<td>train_loader:data.DataLoader,</td>
</tr>
<tr class="odd">
<td>target_dim</td>
<td>int</td>
<td></td>
</tr>
<tr class="even">
<td>device</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="training-on-a-toy-dataset" class="level1">
<h1>Training on a Toy Dataset</h1>
<p>We’ll first verify that the neural ode works by learning a transformation from the moons dataset (in 2d) to a uniform distribution, and then reversing the process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.nn <span class="im">import</span> Augmenter</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchdyn.models <span class="im">import</span> CNF</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>trainable_flows <span class="op">=</span> FlowNet(dimension<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>flow <span class="op">=</span> CNF(trainable_flows)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> NeuralODE(flow, sensitivity<span class="op">=</span><span class="st">'adjoint'</span>, solver<span class="op">=</span><span class="st">'dopri5'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Your vector field callable (nn.Module) should have both time `t` and state `x` as arguments, we've wrapped it for you.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create our PyLightning learner to handle training steps</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>flattener <span class="op">=</span> GreatFlattener(model, input_dim<span class="op">=</span><span class="dv">2</span>, target_dim<span class="op">=</span><span class="dv">2</span>, device<span class="op">=</span>device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> moons_trainloader:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> [x[<span class="dv">0</span>].to(device)]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    dataset_after_flow, J <span class="op">=</span> flattener(x, t_span<span class="op">=</span>torch.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    dataset_after_flow <span class="op">=</span> dataset_after_flow.detach().cpu().numpy()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create our PyLightning trainer to actually train the model</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> pl.Trainer(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    max_epochs<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: gradient clipping can help prevent exploding gradients</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    gradient_clip_val<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    gradient_clip_algorithm<span class="op">=</span><span class="st">'value'</span>,    </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    log_every_n_steps<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: this should match your device i.e. if you set cuda above, this should be cuda. </span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Otherwise it should be cpu. </span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    accelerator<span class="op">=</span><span class="st">"cuda"</span>,    </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: you can set the maximum time you want to train your model</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    max_time<span class="op">=</span>{<span class="st">'minutes'</span>: <span class="dv">5</span>},    </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">NOTE</span><span class="co">: setting this to true will save your model every so often</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    enable_checkpointing<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    accumulate_grad_batches<span class="op">=</span><span class="dv">2</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
/home/piriac/mambaforge/envs/diffusion_curvature/lib/python3.11/site-packages/pytorch_lightning/trainer/connectors/logger_connector/logger_connector.py:67: Starting from v1.9.0, `tensorboardX` has been removed as a dependency of the `pytorch_lightning` package, due to potential conflicts with other packages in the ML ecosystem. For this reason, `logger=True` will use `CSVLogger` as the default logger, unless the `tensorboard` or `tensorboardX` packages are found. Please `pip install lightning[extra]` or one of them to enable TensorBoard support by default</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>trainer.fit(flattener, moons_trainloader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>You are using a CUDA device ('NVIDIA GeForce RTX 4090') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name      | Type                            | Params
--------------------------------------------------------------
0 | model     | NeuralODE                       | 35.9 K
1 | loss      | NegativeLogLikelihoodQuaUniform | 35.9 K
2 | augmenter | Augmenter                       | 0     
--------------------------------------------------------------
35.9 K    Trainable params
0         Non-trainable params
35.9 K    Total params
0.144     Total estimated model params size (MB)
/home/piriac/mambaforge/envs/diffusion_curvature/lib/python3.11/site-packages/pytorch_lightning/trainer/connectors/data_connector.py:441: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=31` in the `DataLoader` to improve performance.
/home/piriac/mambaforge/envs/diffusion_curvature/lib/python3.11/site-packages/pytorch_lightning/loops/fit_loop.py:293: The number of training batches (1) is smaller than the logging interval Trainer(log_every_n_steps=5). Set a lower value for log_every_n_steps if you want to see logs for the training epoch.
/home/piriac/mambaforge/envs/diffusion_curvature/lib/python3.11/site-packages/pytorch_lightning/trainer/call.py:54: Detected KeyboardInterrupt, attempting graceful shutdown...</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e5db6d0e1360456d875155078638db33","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>prior <span class="op">=</span> torch.distributions.uniform.Uniform(<span class="op">-</span>torch.ones(<span class="dv">2</span>).to(device)<span class="op">-</span><span class="fl">0.01</span>, torch.ones(<span class="dv">2</span>).to(device)<span class="op">+</span><span class="fl">0.01</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.rand(<span class="dv">100</span>,<span class="dv">2</span>).to(device)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>prior.log_prob(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031],
        [-0.7031, -0.7031]], device='cuda:0')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>prior</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Uniform(low: torch.Size([2]), high: torch.Size([2]))</code></pre>
</div>
</div>
<p>Running structured data through the model should generate noise - or, euphemistically - flattened data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>flattener <span class="op">=</span> flattener.to(device)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> moons_trainloader:</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    dataset_after_flow, J <span class="op">=</span> flattener([x[<span class="dv">0</span>].to(device)], t_span<span class="op">=</span>torch.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    dataset_after_flow <span class="op">=</span> dataset_after_flow.detach().cpu().numpy()</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co"># print(dataset_after_flow)</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>plt.scatter(dataset_after_flow[:,<span class="dv">0</span>],dataset_after_flow[:,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.collections.PathCollection&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>And running data backwards through the model should generate more data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> flattener.generate_data(<span class="dv">1000</span>).detach().cpu().numpy()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(samples[:,<span class="dv">0</span>], samples[:,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.collections.PathCollection&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-31-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># evaluate vector field</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>trajectory <span class="op">=</span> flattener([torch.tensor(X_moons).<span class="bu">float</span>()],t_span<span class="op">=</span>torch.linspace(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">5</span>), return_trajectory<span class="op">=</span><span class="va">True</span>).detach()</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>n_pts <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> torch.linspace(trajectory[:,:,<span class="dv">1</span>].<span class="bu">min</span>(), trajectory[:,:,<span class="dv">1</span>].<span class="bu">max</span>(), n_pts)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> torch.linspace(trajectory[:,:,<span class="dv">2</span>].<span class="bu">min</span>(), trajectory[:,:,<span class="dv">2</span>].<span class="bu">max</span>(), n_pts)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>X, Y <span class="op">=</span> torch.meshgrid(x, y) </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> torch.cat([X.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>), Y.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)], <span class="dv">1</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> flattener.augmenter(z)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> flattener.model.vf(<span class="dv">0</span>,z).cpu().detach()</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>fx, fy <span class="op">=</span> f[:,<span class="dv">0</span>], f[:,<span class="dv">1</span>] <span class="op">;</span> fx, fy <span class="op">=</span> fx.reshape(n_pts , n_pts), fy.reshape(n_pts, n_pts)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plot vector field and its intensity</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">4</span>, <span class="dv">4</span>)) <span class="op">;</span> ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>ax.streamplot(X.numpy().T, Y.numpy().T, fx.numpy().T, fy.numpy().T, color<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>ax.contourf(X.T, Y.T, torch.sqrt(fx.T<span class="op">**</span><span class="dv">2</span><span class="op">+</span>fy.T<span class="op">**</span><span class="dv">2</span>), cmap<span class="op">=</span><span class="st">'RdYlBu'</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>transformed_points <span class="op">=</span> torch.randn(<span class="dv">50</span>,<span class="dv">2</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>transformed_points</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>RuntimeError: Expected all tensors to be on the same device, but found at least two devices, cuda:0 and cpu! (when checking argument for argument mat1 in method wrapper_CUDA_addmm)</code></pre>
</div>
</div>
</section>
<section id="an-sklearn-like-interface-to-the-node" class="level1">
<h1>An sklearn like interface to the nODE</h1>
<p>We’ve now verified that the nODE machinery works, and can reproduce a reasonable facsimile of the moons dataset, as well as turn the dataset into an approximation of gaussian noise. If trained longer, it would likely have greater fidelity.</p>
<p>Our next step is simple: wrapping the above into a function that produces an nODE-flattened version of <em>any</em> supplied data.</p>
<hr>
<section id="neural_flattener" class="level3">
<h3 class="anchored" data-anchor-id="neural_flattener">neural_flattener</h3>
<blockquote class="blockquote">
<pre><code> neural_flattener (device, max_epochs=1000)</code></pre>
</blockquote>
<p>Initialize self. See help(type(self)) for accurate signature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>NF <span class="op">=</span> neural_flattener(device<span class="op">=</span>device, max_epochs<span class="op">=</span><span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>transformed_moons <span class="op">=</span> NF.fit_transform(X_moons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name      | Type                            | Params
--------------------------------------------------------------
0 | model     | NeuralODE                       | 35.9 K
1 | loss      | NegativeLogLikelihoodQuaUniform | 35.9 K
2 | augmenter | Augmenter                       | 0     
--------------------------------------------------------------
35.9 K    Trainable params
0         Non-trainable params
35.9 K    Total params
0.144     Total estimated model params size (MB)
`Trainer.fit` stopped: `max_epochs=25` reached.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Your vector field callable (nn.Module) should have both time `t` and state `x` as arguments, we've wrapped it for you.
tensor([[ 0.3370, -0.3010],
        [ 0.3345, -0.2901],
        [ 0.3335, -0.2763],
        ...,
        [ 0.9484,  0.2218],
        [ 1.0000,  0.3369],
        [ 0.9512,  0.2579]], device='cuda:0')</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"48fd6fce4df14b4dac21f84d83eb4b3a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(transformed_moons[:,<span class="dv">0</span>].cpu().detach().numpy(),transformed_moons[:,<span class="dv">1</span>].cpu().detach().numpy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.collections.PathCollection&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="continuous_normalizing_flows_files/figure-html/cell-36-output-2.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>