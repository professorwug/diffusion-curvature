<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.358">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>diffusion_curvature - Implementation (PyGSP + JAX)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="diffusion_curvature - Implementation (PyGSP + JAX)">
<meta property="og:description" content="Fast, pointwise graph curvature">
<meta property="og:site_name" content="diffusion_curvature">
<meta name="twitter:title" content="diffusion_curvature - Implementation (PyGSP + JAX)">
<meta name="twitter:description" content="Fast, pointwise graph curvature">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">diffusion_curvature</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/professorwug/diffusion_curvature"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../library/Comparison Space Construction.html">library</a></li><li class="breadcrumb-item"><a href="../library/Core.html">Implementation (PyGSP + JAX)</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">documentation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../documentation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Curvature</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a Visual Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a A Visual Battery of Benchmarks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a1 DC of Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a1 Computing the diffusion curvature of the battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a1a DC of LowD High Sample Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a1a Computing the diffusion curvature of the battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3a2 Hickok Curvature of Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a2 Hickok Curvature of Battery.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3b Hickok Comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3b Hickok Comparison.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3c Sampling Experiments.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3c Sampling Experiments on Diffusion Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3d Detecting Negative Curvature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3d Detecting Negative Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3d1 Effects of Graph Construction on Negative Curvature Detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3d1 Effects of Graph Construction on Negative Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e Curvature with (Neural) Flattening.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e Curvature Via (Neural) Flattening</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e1 Flattening with Diffusion Models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e1 Flattening with Diffusion Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/3e2 Neural Flattening with Gromov Wasserstein.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3e2 Neural Flattening with Gromov Wasserstein</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Curvature Filtrations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Curvature Filtrations.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Curvature by Quadratic Fitting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Scalar Curvature by Volume Comparison</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Diffusion Laziness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Measurements of Diffusion Laziness</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Examples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Examples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Explorations in Lazy-first diffusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Explorations in Lazy-first Diffusion Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Loss Landscapes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Curvature of Loss Landscapes</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Neumann Heat Kernel via Chebyshev Approximation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analytic estimation of the heat kernel</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Sampling Semifinals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Flattening Semifinals</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/Wasserstein Laziness of Diffusion with HeatGeo Distances.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Getting Diffusion Curvature with Wasserstein Laziness</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../experiments/continuous_normalizing_flows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mapping the Data to a Flat Space with Continuous Normalizing Flows</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">library</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Comparison Space Construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Comparison Space Construction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Construct Battery.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3a Construct Battery</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Core PyKeops.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Core (PyKeops)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Implementation (PyGSP + JAX)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Curvature Enhanced Spectral Clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1d Curvature Clustering</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Datasets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Entropy for Optimal t.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Entropy for Optimal t.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Laziness.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Laziness Estimators</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Diffusion Ricci Curvature.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Diffusion Ricci Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Graph Creation Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Heat Diffusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Heat Diffusion</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Kernels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Kernels</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/MIOFlow for Neural Flattening.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MIOFlow for Neural Flattening</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Manifold Distances.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Manifold Distances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Mean Flat Entropies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1c1 Mean Entropy of Uniform Flat Spaces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Radial Flattening Autoencoder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Radial Flattening Autoencoder</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Random Surfaces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Surfaces</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Sampling Distance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampling Distance</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Similar Sampling Benchmarker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Similar Sampling Benchmarker.html</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../library/Volume Estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Volume Estimation with Heat Diffusion</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#graph-construction" id="toc-graph-construction" class="nav-link active" data-scroll-target="#graph-construction">Graph Construction</a></li>
  <li><a href="#the-diffusion-curvature-class" id="toc-the-diffusion-curvature-class" class="nav-link" data-scroll-target="#the-diffusion-curvature-class">The Diffusion Curvature Class</a></li>
  <li><a href="#verification" id="toc-verification" class="nav-link" data-scroll-target="#verification">Verification</a>
  <ul>
  <li><a href="#with-approximated-heat-diffusion" id="toc-with-approximated-heat-diffusion" class="nav-link" data-scroll-target="#with-approximated-heat-diffusion">With Approximated Heat Diffusion</a></li>
  <li><a href="#on-the-plane" id="toc-on-the-plane" class="nav-link" data-scroll-target="#on-the-plane">On the Plane</a></li>
  <li><a href="#how-bout-a-donut" id="toc-how-bout-a-donut" class="nav-link" data-scroll-target="#how-bout-a-donut">How bout a donut?</a>
  <ul class="collapse">
  <li><a href="#with-entropic-subtraction-fixed-flattening" id="toc-with-entropic-subtraction-fixed-flattening" class="nav-link" data-scroll-target="#with-entropic-subtraction-fixed-flattening">With Entropic, Subtraction, Fixed Flattening</a></li>
  <li><a href="#with-wasserstein-subtraction-fixed-flattening" id="toc-with-wasserstein-subtraction-fixed-flattening" class="nav-link" data-scroll-target="#with-wasserstein-subtraction-fixed-flattening">With Wasserstein, Subtraction, Fixed Flattening</a></li>
  <li><a href="#with-grid" id="toc-with-grid" class="nav-link" data-scroll-target="#with-grid">With Grid</a></li>
  <li><a href="#with-wasserstein" id="toc-with-wasserstein" class="nav-link" data-scroll-target="#with-wasserstein">With Wasserstein</a></li>
  <li><a href="#with-laziness" id="toc-with-laziness" class="nav-link" data-scroll-target="#with-laziness">With Laziness</a></li>
  <li><a href="#with-vne-t-selection" id="toc-with-vne-t-selection" class="nav-link" data-scroll-target="#with-vne-t-selection">With VNE t selection</a></li>
  <li><a href="#with-neural-flattening" id="toc-with-neural-flattening" class="nav-link" data-scroll-target="#with-neural-flattening">With Neural Flattening</a></li>
  <li><a href="#with-mean-flattening" id="toc-with-mean-flattening" class="nav-link" data-scroll-target="#with-mean-flattening">With Mean Flattening</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/professorwug/diffusion_curvature/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../library/Comparison Space Construction.html">library</a></li><li class="breadcrumb-item"><a href="../library/Core.html">Implementation (PyGSP + JAX)</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Implementation (PyGSP + JAX)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>

<p>::: {#cell-1 .cell 0=‘d’ 1=‘e’ 2=‘f’ 3=‘a’ 4=‘u’ 5=‘l’ 6=‘t’ 7=’_’ 8=‘e’ 9=‘x’ 10=‘p’ 11=’ ’ 12=‘c’ 13=‘o’ 14=‘r’ 15=‘e’}</p>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Standard libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure environment</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">'XLA_PYTHON_CLIENT_PREALLOCATE'</span>]<span class="op">=</span><span class="st">'false'</span> <span class="co"># Tells Jax not to hog all of the memory to this process.</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">## Imports for plotting</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> set_matplotlib_formats</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># set_matplotlib_formats('svg', 'pdf') # For export</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> to_rgba</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>()</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">## Progress bar</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co">## project specifics</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> diffusion_curvature</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.kernels <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.datasets <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>jax.devices()</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload</code></pre>
</div>
<p>:::</p>
<blockquote class="blockquote">
<p>Curvature computations on any graphtools graph</p>
</blockquote>
<p>This notebook implements diffusion curvature atop the popular PyGSP library. To compute the curvature of any PyGSP graph, simply instantiate a <code>DiffusionCurvature</code> object with your choice of parameters, and pass the graphtools graph through as input.</p>
<p>What follows is a literate implementation, showing the steps of the algorithm applied to our old friend, the torus.</p>
<p>The implementation of Diffusion Curvature involves several big pieces, each of which can be performed with different strategies:</p>
<ol type="1">
<li>Simulating heat diffusion on the manifold, either via powering the diffusion matrix, or by Chebyshev approximation of the heat equation using the graph laplacian.</li>
<li>Computing the “spreads” of diffusion. This can be done either via the entropy or the Wasserstein distance.</li>
<li>Constructing a comparison space of approximately the same sampling as the input graph.</li>
<li>(Experimental) Verification that the above is working by differentiating the spreads of diffusion over time.</li>
</ol>
<p>We implement everything generically in JAX (a high performance numpy replacement, which can compile to the GPU), treating each of the above as modules that can be parametrically tuned. Functional programming is our game: each function takes a graph object as input and returns an updated graph object with the required quantities computed.</p>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.datasets <span class="im">import</span> torus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Our sample dataset for testing the rest of the notebook</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>X_torus, ks_torus <span class="op">=</span> torus(<span class="dv">5000</span>,use_guide_points<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="graph-construction" class="level1">
<h1>Graph Construction</h1>
<p>Our ‘Graphs’ notebook has code to create PyGSP graphs from pointcloud data, in several varieties. We also provide heuristics to sanity check the graphs, as well as choose the optimal parameters. TODO: MAKE THESE HEURISTICS</p>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.graphs <span class="im">import</span> get_alpha_decay_graph, get_knn_graph, get_scanpy_graph</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>G_torus <span class="op">=</span> get_alpha_decay_graph(X_torus,knn<span class="op">=</span><span class="dv">15</span>,decay<span class="op">=</span><span class="dv">20</span>,anisotropy<span class="op">=</span><span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-diffusion-curvature-class" class="level1">
<h1>The Diffusion Curvature Class</h1>
<p>::: {#cell-11 .cell 0=‘e’ 1=‘x’ 2=‘p’ 3=‘o’ 4=‘r’ 5=‘t’}</p>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pygsp</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> skdim</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> normalize</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> inspect <span class="im">import</span> getfullargspec</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Callable, Literal, get_args, get_origin</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> graphtools</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> trange, tqdm</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.experimental <span class="im">import</span> sparse</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.graphs <span class="im">import</span> diff_aff, diff_op, diffusion_matrix_from_affinities</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.heat_diffusion <span class="im">import</span> heat_diffusion_on_signal, kronecker_delta, jax_power_matrix, heat_diffusion_from_dirac</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.diffusion_laziness <span class="im">import</span> wasserstein_spread_of_diffusion, entropy_of_diffusion</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.distances <span class="im">import</span> phate_distances_differentiable</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.comparison_space <span class="im">import</span> EuclideanComparisonSpace, fit_comparison_space_model, euclidean_comparison_graph, construct_ndgrid_from_shape, diffusion_coordinates, load_average_entropies</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.clustering <span class="im">import</span> enhanced_spectral_clustering</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.normalizing_flows <span class="im">import</span> neural_flattener</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.vne <span class="im">import</span> optimal_t_via_vne</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.utils <span class="im">import</span> random_jnparray</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> diffusion_curvature</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co"># import deepdish</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> h5py</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>_DIFFUSION_TYPES <span class="op">=</span> Literal[<span class="st">'diffusion matrix'</span>,<span class="st">'heat kernel'</span>]</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>_LAZINESS_METHOD <span class="op">=</span> Literal[<span class="st">'Wasserstein'</span>,<span class="st">'Entropic'</span>, <span class="st">'Laziness'</span>]</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>_FLATTENING_METHOD <span class="op">=</span> Literal[<span class="st">'Neural'</span>, <span class="st">'Fixed'</span>, <span class="st">'Mean Fixed'</span>]</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>_COMPARISON_METHOD <span class="op">=</span> Literal[<span class="st">'Ollivier'</span>, <span class="st">'Subtraction'</span>]</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> graphtools_graph_from_data(X):</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> graphtools.Graph(X, anisotropy<span class="op">=</span><span class="dv">1</span>, knn<span class="op">=</span><span class="dv">15</span>, decay<span class="op">=</span><span class="va">None</span>).to_pygsp()</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> diffusion_curvature.kernels <span class="im">import</span> gaussian_kernel</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SimpleGraph:</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    W: np.ndarray</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_adaptive_graph(X, k<span class="op">=</span><span class="dv">10</span>, alpha <span class="op">=</span> <span class="dv">0</span>):</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> gaussian_kernel(</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        kernel_type<span class="op">=</span><span class="st">'adaptive'</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> k,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        anisotropic_density_normalization <span class="op">=</span> alpha,</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> pygsp.graphs.Graph(W)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> G</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DiffusionCurvature():</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>,</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>            diffusion_type:_DIFFUSION_TYPES <span class="op">=</span> <span class="st">'diffusion matrix'</span>, <span class="co"># Either ['diffusion matrix','heat kernel']</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            laziness_method: _LAZINESS_METHOD <span class="op">=</span> <span class="st">'Entropic'</span>, <span class="co"># Either ['Wasserstein','Entropic', 'Laziness']</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            flattening_method: _FLATTENING_METHOD <span class="op">=</span> <span class="st">'Fixed'</span>, <span class="co"># Either ['Neural', 'Fixed', 'Mean Fixed']</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            comparison_method: _COMPARISON_METHOD <span class="op">=</span> <span class="st">'Subtraction'</span>, <span class="co"># Either ['Ollivier', 'Subtraction']</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            graph_former <span class="op">=</span> get_adaptive_graph,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            dimest <span class="op">=</span> <span class="va">None</span>, <span class="co"># Dimension estimator to use. If none, defaults to kNN.</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>            points_per_cluster <span class="op">=</span> <span class="va">None</span>, <span class="co"># Number of points to use in each cluster when constructing comparison spaces. Each comparison space takes about 20sec to construct, and has different sampling and dimension. If 1, constructs a different comparison space for each point; if None, constructs just one comparison space.</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>            comparison_space_size_factor <span class="op">=</span> <span class="dv">1</span>, <span class="co"># Number of points in comparison space is the number of points in the original space divided by this factor.</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>            use_grid<span class="op">=</span><span class="va">False</span>, <span class="co"># If True, uses a grid of points as the comparison space. If False, uses a random sample of points.            </span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>            max_flattening_epochs<span class="op">=</span><span class="dv">50</span>,     </span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            aperture <span class="op">=</span> <span class="dv">20</span>, <span class="co"># if using Laziness flattening, this controls the size of neighborhood over which the return probability is averaged.</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>            smoothing<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>            comparison_space_file <span class="op">=</span> <span class="st">"../data/entropies_averaged.h5"</span>,</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            verbose <span class="op">=</span> <span class="va">False</span>,</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        store_attr()</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.D <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.graph_former <span class="op">=</span> graph_former</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.dimest <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.dimest <span class="op">=</span> skdim.<span class="bu">id</span>.KNN()</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.flattening_method <span class="op">==</span> <span class="st">"Mean Fixed"</span>:</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.SGT <span class="op">=</span> load_average_entropies(comparison_space_file)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            <span class="co"># deepdish.io.load("../data/sgt_peppers_averaged_flat_entropies.h5") # dict of dim x knn x ts containing precomputed flat entropies.</span></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> unsigned_curvature(</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>,</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>            G:pygsp.graphs.Graph, <span class="co"># PyGSP input Graph</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>            t:<span class="bu">int</span>, <span class="co"># Scale at which to compute curvature; number of steps of diffusion.</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>            idx<span class="op">=</span><span class="va">None</span>, <span class="co"># the index at which to compute curvature. If None, computes for all points. </span><span class="al">TODO</span><span class="co">: Implement</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>            <span class="co"># The below are used internally</span></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>            _also_return_first_scale <span class="op">=</span> <span class="va">False</span>, <span class="co"># if True, calculates the laziness measure at both specified t and t=1. The distances (if used) are calcualted with the larger t.</span></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            D <span class="op">=</span> <span class="va">None</span>, <span class="co"># Supply manifold distances yourself to override their computation. Only used with the Wasserstein laziness method.</span></span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> G.W.shape[<span class="dv">0</span>]</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute diffusion matrix</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="va">self</span>.diffusion_type:</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">'diffusion matrix'</span>:</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>                P <span class="op">=</span> normalize(G.W, norm<span class="op">=</span><span class="st">"l1"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">type</span>(P) <span class="op">==</span> scipy.sparse._csr.csr_matrix:</span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>                    P <span class="op">=</span> P.todense()</span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>                <span class="co"># diffusion_matrix_from_affinities(G.W)</span></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>                <span class="co"># P = diff_op(G).todense() # is sparse, by default</span></span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.P <span class="op">=</span> jnp.array(P)</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span>: t <span class="op">=</span> optimal_t_via_vne(P)</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Pt <span class="op">=</span> jax_power_matrix(<span class="va">self</span>.P,t)</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">'heat kernel'</span>:</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> t <span class="kw">is</span> <span class="va">None</span>: </span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>                    normal_P <span class="op">=</span> normalize(G.W, norm<span class="op">=</span><span class="st">"l1"</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">type</span>(normal_P) <span class="op">==</span> scipy.sparse._csr.csr_matrix:</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>                        normal_P <span class="op">=</span> normal_P.todense()</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>                    normal_P <span class="op">=</span> jnp.array(normal_P)</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>                    t <span class="op">=</span> optimal_t_via_vne(normal_P)</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>                Ps <span class="op">=</span> heat_diffusion_from_dirac(G, idx<span class="op">=</span>idx, t<span class="op">=</span>[<span class="dv">1</span>,t])</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>                <span class="co"># signal = jnp.eye(n) if idx is not None else kronecker_delta(n,idx=idx)</span></span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Ps = heat_diffusion_on_signal(G, signal, [1,t])</span></span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.P <span class="op">=</span> Ps[<span class="dv">0</span>]</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.Pt <span class="op">=</span> Ps[<span class="dv">1</span>]</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _:</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Diffusion Type </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>diffusion_type<span class="sc">}</span><span class="ss"> not in </span><span class="sc">{</span>_DIFFUSION_TYPES<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="va">self</span>.laziness_method:</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">"Wasserstein"</span>:</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> D <span class="kw">is</span> <span class="va">None</span>: D <span class="op">=</span> phate_distances_differentiable(<span class="va">self</span>.Pt) <span class="co">#TODO: Could be more efficient here if there's an idx</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>                laziness <span class="op">=</span> wasserstein_spread_of_diffusion(D,<span class="va">self</span>.Pt) <span class="cf">if</span> idx <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> wasserstein_spread_of_diffusion(D[idx],<span class="va">self</span>.Pt[idx])</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> _also_return_first_scale: laziness_nought <span class="op">=</span> wasserstein_spread_of_diffusion(D,<span class="va">self</span>.P)</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">"Entropic"</span>:</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>                laziness <span class="op">=</span> entropy_of_diffusion(<span class="va">self</span>.Pt) <span class="cf">if</span> idx <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> entropy_of_diffusion(<span class="va">self</span>.Pt[idx])</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>                <span class="co"># laziness = entropy_of_diffusion(self.P) / entropy_of_diffusion(self.Pt)</span></span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> _also_return_first_scale: laziness_nought <span class="op">=</span> entropy_of_diffusion(<span class="va">self</span>.P)</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">"Laziness"</span>:</span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>                thresholds <span class="op">=</span> jnp.partition(<span class="va">self</span>.P,<span class="op">-</span><span class="va">self</span>.aperture)[:,<span class="op">-</span><span class="va">self</span>.aperture] <span class="co"># aperture controls the size of the neighborhood in which laziness is measured</span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>                P_thresholded <span class="op">=</span> (<span class="va">self</span>.P <span class="op">&gt;=</span> thresholds[:,<span class="va">None</span>]).astype(<span class="bu">int</span>) </span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>                near_neighbors_only <span class="op">=</span> <span class="va">self</span>.Pt <span class="op">*</span> P_thresholded</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>                laziness_aggregate <span class="op">=</span> jnp.<span class="bu">sum</span>(near_neighbors_only,axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>                <span class="co"># divide by the number of neighbors diffused to</span></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>                ones_remaining <span class="op">=</span> jnp.ones_like(P_thresholded) <span class="op">*</span> P_thresholded <span class="co"># is this needed? Isn't ones_remaining identical to P_thresholded?</span></span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>                local_density <span class="op">=</span> jnp.<span class="bu">sum</span>(ones_remaining,axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.verbose: <span class="bu">print</span>(<span class="st">"local density"</span>,local_density)</span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>                local_density <span class="op">=</span> local_density.at[local_density<span class="op">==</span><span class="dv">0</span>].<span class="bu">set</span>(<span class="dv">1</span>) <span class="co"># In case of isolated points, replace local density of 0 with 1. THe laziness will evaluate to zero.</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>                laziness_aggregate <span class="op">=</span> laziness_aggregate <span class="op">/</span> local_density </span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>                laziness <span class="op">=</span> laziness_aggregate</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.smoothing: <span class="co"># </span><span class="al">TODO</span><span class="co"> there are probably more intelligent ways to do this smoothing</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Local averaging to counter the effects local density</span></span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.verbose: <span class="bu">print</span>(<span class="st">"Applying smoothing..."</span>)</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>                    smoothing_P_powered <span class="op">=</span> jnp.linalg.matrix_power(<span class="va">self</span>.P,<span class="va">self</span>.smoothing)</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>                    average_laziness <span class="op">=</span> smoothing_P_powered <span class="op">@</span> laziness_aggregate[:,<span class="va">None</span>]</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>                    laziness <span class="op">=</span> average_laziness.squeeze()</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> _also_return_first_scale: laziness_nought <span class="op">=</span> jnp.<span class="bu">sum</span>(<span class="va">self</span>.P <span class="op">*</span> P_thresholded,axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _:</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Laziness Method </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>laziness_method<span class="sc">}</span><span class="ss"> not in </span><span class="sc">{</span>_LAZINESS_METHOD<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _also_return_first_scale: </span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> laziness, laziness_nought, <span class="va">self</span>.P, <span class="va">self</span>.Pt, t</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> laziness</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> curvature(</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>,</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>            G:pygsp.graphs.Graph, <span class="co"># Input Graph</span></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>            t:<span class="bu">int</span>, <span class="co"># Scale; if none, finds the knee-point of the spectral entropy curve of the diffusion operator</span></span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>            idx<span class="op">=</span><span class="va">None</span>, <span class="co"># the index at which to compute curvature. If None, computes for all points.</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>            dim <span class="op">=</span> <span class="va">None</span>, <span class="co"># the INTRINSIC dimension of your manifold, as an int for global dimension or list of pointwise dimensions; if none, tries to estimate pointwise.</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>            knn <span class="op">=</span> <span class="dv">15</span>, <span class="co"># Number of neighbors used in construction of graph;</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>            D <span class="op">=</span> <span class="va">None</span>, <span class="co"># Supply manifold distances yourself to override their computation. Only used with the Wasserstein laziness method.</span></span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>        fixed_comparison_cache <span class="op">=</span> {} <span class="co"># if using a fixed comparison space, saves by dimension</span></span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> get_flat_spreads(dimension, jump_of_diffusion, num_points_in_comparison, cluster_idxs, verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> <span class="va">self</span>.flattening_method:</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">"Fixed"</span>:</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> dimension <span class="kw">not</span> <span class="kw">in</span> fixed_comparison_cache.keys():</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="va">self</span>.use_grid:</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>                            Rn <span class="op">=</span> construct_ndgrid_from_shape(dimension, <span class="bu">int</span>(num_points_in_comparison<span class="op">**</span>(<span class="dv">1</span><span class="op">/</span>dimension)))</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>                            Rn <span class="op">=</span> jnp.concatenate([jnp.zeros((<span class="dv">1</span>,dim)), <span class="dv">2</span><span class="op">*</span>random_jnparray(num_points_in_comparison<span class="op">-</span><span class="dv">1</span>, dim)<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># construct a lattice in dim dimensions of num_points_in_comparison points</span></span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>                        G <span class="op">=</span> <span class="va">self</span>.graph_former(Rn)</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># G = graphtools.Graph(Rn, anisotropy=1, knn=knn, decay=None,).to_pygsp()</span></span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="va">self</span>.laziness_method <span class="op">==</span> <span class="st">"Wasserstein"</span>: </span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>                            fixed_comparison_cache[dimension] <span class="op">=</span> (G, scipy.spatial.distance_matrix(Rn,Rn))</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>: </span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>                            fixed_comparison_cache[dimension] <span class="op">=</span> (G, <span class="va">None</span>)</span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>                    G_euclidean, D_euclidean <span class="op">=</span> fixed_comparison_cache[dimension]</span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># print(type(G_euclidean))</span></span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># print(G_euclidean.W)</span></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>                    fs <span class="op">=</span> <span class="va">self</span>.unsigned_curvature(G_euclidean,t,idx<span class="op">=</span><span class="dv">0</span>,D<span class="op">=</span>D_euclidean)   </span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.verbose: <span class="bu">print</span>(<span class="ss">f"comparison entropy is </span><span class="sc">{</span>fs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> fs</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">"Kernel Matching"</span>:</span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>                    model <span class="op">=</span> EuclideanComparisonSpace(dimension<span class="op">=</span>dimension, num_points<span class="op">=</span>num_points_in_comparison, jump_of_diffusion<span class="op">=</span>jump_of_diffusion,)</span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>                    params <span class="op">=</span> fit_comparison_space_model(model, max_epochs<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> verbose: <span class="bu">print</span>(params)</span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>                    euclidean_stuffs <span class="op">=</span> model.<span class="bu">apply</span>(params) <span class="co"># dictionary containing A, P, D</span></span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>                    W <span class="op">=</span> fill_diagonal(euclidean_stuffs[<span class="st">'A'</span>],<span class="dv">0</span>)</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>                    G_euclidean <span class="op">=</span> pygsp.graphs.Graph(</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>                        W <span class="op">=</span> W,</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>                        lap_type <span class="op">=</span> G.lap_type, <span class="co"># type of laplacian; we'll use the same as inputted.</span></span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>                    fs <span class="op">=</span> <span class="va">self</span>.unsigned_curvature(G_euclidean,t,idx<span class="op">=</span><span class="dv">0</span>, D<span class="op">=</span>euclidean_stuffs[<span class="st">'D'</span>])</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> fs</span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">"Neural"</span>:</span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>                    device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>                    NF <span class="op">=</span> neural_flattener(device<span class="op">=</span>device, max_epochs<span class="op">=</span><span class="va">self</span>.max_flattening_epochs)</span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># for now, we assume that the neural flattener is only used with single point clusters</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># </span><span class="al">TODO</span><span class="co">: generalize to multiple point clusters by finding centroid</span></span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>                    distances_to_manfred <span class="op">=</span> jnp.<span class="bu">sum</span>(jnp.array(</span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>                        [jnp.linalg.norm(<span class="va">self</span>.diff_coords <span class="op">-</span> <span class="va">self</span>.diff_coords[clustidx],axis<span class="op">=</span><span class="dv">1</span>) <span class="cf">for</span> clustidx <span class="kw">in</span> cluster_idxs]</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>                    ),axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>                    idx_closest_to_manfred <span class="op">=</span> jnp.argsort(distances_to_manfred)[:num_points_in_comparison]</span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>                    diff_coords_of_comparison_space <span class="op">=</span> <span class="va">self</span>.diff_coords[idx_closest_to_manfred]</span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>                    flattened_diff_coords <span class="op">=</span> NF.fit_transform(</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>                        torch.tensor(diff_coords_of_comparison_space.tolist())</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># construct graph out of these flattened coordinates</span></span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>                    G_euclidean <span class="op">=</span> graphtools.Graph(flattened_diff_coords, knn<span class="op">=</span><span class="dv">15</span>, decay<span class="op">=</span><span class="va">None</span>, anisotropy<span class="op">=</span><span class="dv">1</span>).to_pygsp()</span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>                    fs <span class="op">=</span> <span class="va">self</span>.unsigned_curvature(G_euclidean, t, idx<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> fs</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># return G_euclidean, None # </span><span class="al">TODO</span><span class="co">: compute diffusion distances</span></span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>                <span class="cf">case</span> <span class="st">"Mean Fixed"</span>:</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>                    dimension_checks_out <span class="op">=</span> dimension <span class="kw">in</span> <span class="va">self</span>.SGT.keys()</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>                    knn_checks_out <span class="op">=</span> knn <span class="kw">in</span> <span class="va">self</span>.SGT[dimension].keys() <span class="cf">if</span> dimension_checks_out <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>                    t_checks_out <span class="op">=</span> t <span class="kw">in</span> <span class="va">self</span>.SGT[dimension][knn].keys() <span class="cf">if</span> knn_checks_out <span class="cf">else</span> <span class="va">False</span></span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> (dimension_checks_out <span class="kw">and</span> knn_checks_out <span class="kw">and</span> t_checks_out):</span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># compute the old way</span></span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="st">"Flat space not precomputed; computing now"</span>)</span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.flattening_method <span class="op">=</span> <span class="st">"Fixed"</span></span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> get_flat_spreads(</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>                            dimension <span class="op">=</span> dimension,</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>                            jump_of_diffusion <span class="op">=</span> jump_of_diffusion,</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>                            num_points_in_comparison <span class="op">=</span> num_points_in_comparison,</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>                            cluster_idxs <span class="op">=</span> cluster_idxs,</span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>                            verbose<span class="op">=</span>verbose</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>                            )</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="va">self</span>.SGT[dimension][knn][t]    </span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Start by estimating the manifold's unsigned curvature, i.e. spreads of diffusion</span></span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>        manifold_spreads, manifold_spreads_nought, P, Pt, t <span class="op">=</span> <span class="va">self</span>.unsigned_curvature(G,t,idx, _also_return_first_scale<span class="op">=</span><span class="va">True</span>, D <span class="op">=</span> D)</span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.verbose: <span class="bu">print</span>(<span class="ss">f"Manifold spreads are </span><span class="sc">{</span>manifold_spreads<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(manifold_spreads_nought.shape)</span></span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> G.W.shape[<span class="dv">0</span>]</span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dim <span class="kw">is</span> <span class="va">None</span>: <span class="co"># The dimension wasn't supplied; we'll estimate it pointwise</span></span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"estimating local dimension of each point... may take a while"</span>)</span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>            ldims <span class="op">=</span> <span class="va">self</span>.dimest.fit_pw(</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>                                G.data, <span class="co">#TODO: Currently this requires underlying points!</span></span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>                                n_neighbors <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>                                n_jobs <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>            dims_per_point <span class="op">=</span> np.<span class="bu">round</span>(ldims.dimension_pw_).astype(<span class="bu">int</span>)</span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="co"># the dimension *was* supplied, but it may be either a single global dimension or a local dimension for each point</span></span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(dim, <span class="bu">int</span>):</span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>                dims_per_point <span class="op">=</span> jnp.ones(G.W.shape[<span class="dv">0</span>], dtype<span class="op">=</span><span class="bu">int</span>)<span class="op">*</span>dim</span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>                dims_per_point <span class="op">=</span> dim</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.flattening_method <span class="op">==</span> <span class="st">"Neural"</span>:</span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>            <span class="co"># we need to compute coordinates to flatten. We'll use diffusion maps for this.</span></span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.diff_coords <span class="op">=</span> diffusion_coordinates(G, t<span class="op">=</span>t)[:,:dim]</span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>        flat_spreads <span class="op">=</span> jnp.zeros(n)</span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>        num_points_in_comparison <span class="op">=</span> n <span class="op">//</span> <span class="va">self</span>.comparison_space_size_factor <span class="co"># </span><span class="al">TODO</span><span class="co">: Can surely find a better heuristic here</span></span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>        num_clusters <span class="op">=</span> n <span class="op">//</span> <span class="va">self</span>.points_per_cluster <span class="cf">if</span> <span class="va">self</span>.points_per_cluster <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_clusters <span class="op">==</span> n: </span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Construct a separate comparison space for each point</span></span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>            cluster_labels <span class="op">=</span> jnp.arange(n)</span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> num_clusters <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use just one comparison space for the whole dataset</span></span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>            cluster_labels <span class="op">=</span> jnp.zeros(n)</span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> idx <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: </span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>            cluster_labels <span class="op">=</span> jnp.ones(n) <span class="co"># if a single index is supplied, there's only one cluster.</span></span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>            cluster_labels <span class="op">=</span> cluster_labels.at[idx].<span class="bu">set</span>(<span class="dv">0</span>)</span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>            num_clusters <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: </span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Cluster dataset into specified num_clusters, construct separate comparison spaces for each.</span></span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>            cluster_labels <span class="op">=</span> enhanced_spectral_clustering(G, manifold_spreads, dim<span class="op">=</span>dim, num_clusters<span class="op">=</span>num_clusters, )</span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_clusters):</span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>            cluster_idxs <span class="op">=</span> jnp.where(cluster_labels<span class="op">==</span>i)[<span class="dv">0</span>]</span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>            average_dim_in_cluster <span class="op">=</span> <span class="bu">int</span>(jnp.<span class="bu">round</span>(jnp.mean(dims_per_point[cluster_idxs])))</span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.verbose: <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>average_dim_in_cluster<span class="op">=</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>            average_spread_in_cluster <span class="op">=</span> jnp.mean(manifold_spreads_nought[cluster_idxs])</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>            fs <span class="op">=</span> get_flat_spreads(</span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>                dimension <span class="op">=</span> average_dim_in_cluster,</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>                jump_of_diffusion <span class="op">=</span> average_spread_in_cluster,</span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>                num_points_in_comparison <span class="op">=</span> num_points_in_comparison,</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>                cluster_idxs <span class="op">=</span> cluster_idxs,</span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>            <span class="co"># fs = self.unsigned_curvature(G_euclidean,t,idx=0)</span></span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>            flat_spreads <span class="op">=</span> flat_spreads.at[cluster_idxs].<span class="bu">set</span>(</span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>                    fs</span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="va">self</span>.comparison_method:</span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">"Ollivier"</span>:</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>                ks <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> manifold_spreads<span class="op">/</span>flat_spreads</span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> <span class="st">"Subtraction"</span>:</span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>                ks <span class="op">=</span> flat_spreads <span class="op">-</span> manifold_spreads</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _:</span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f'Comparison method must be in </span><span class="sc">{</span>_COMPARISON_METHOD<span class="sc">}</span><span class="ss">'</span>)    </span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> idx <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>: ks <span class="op">=</span> ks[idx]</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ks <span class="co">#, flat_spreads, manifold_spreads, P, Pt</span></span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fill_diagonal(a, val):</span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>  <span class="cf">assert</span> a.ndim <span class="op">&gt;=</span> <span class="dv">2</span></span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>  i, j <span class="op">=</span> jnp.diag_indices(<span class="bu">min</span>(a.shape[<span class="op">-</span><span class="dv">2</span>:]))</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a.at[..., i, j].<span class="bu">set</span>(val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>:::</p>
</section>
<section id="verification" class="level1">
<h1>Verification</h1>
<section id="with-approximated-heat-diffusion" class="level3">
<h3 class="anchored" data-anchor-id="with-approximated-heat-diffusion">With Approximated Heat Diffusion</h3>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>X_torus,ks <span class="op">=</span> torus(<span class="dv">1000</span>,use_guide_points<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>G_torus <span class="op">=</span> get_adaptive_graph(X_torus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:00:13,836:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>G_torus.W.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(1000, 1000)</code></pre>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    diffusion_type <span class="op">=</span> <span class="st">"heat kernel"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    use_grid<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Rn <span class="op">=</span> np.random.rand(<span class="dv">400</span>,<span class="dv">2</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>Grn <span class="op">=</span> DC.graph_former(Rn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 09:58:21,146:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>Grn.W.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(400, 400)</code></pre>
</div>
</div>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="va">None</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: x and y must be the same size</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-15-output-2.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>X_sphere, ks_sphere <span class="op">=</span> sphere(<span class="dv">1000</span>,use_guide_points<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>G_sphere <span class="op">=</span> get_adaptive_graph(X_sphere)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    graph_former <span class="op">=</span> get_adaptive_graph,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>sphere_entropy <span class="op">=</span> DC.unsigned_curvature(G_sphere, t<span class="op">=</span><span class="dv">25</span>)[<span class="dv">0</span>]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Sphere entropies are "</span>, sphere_entropy)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>DC.curvature(G_sphere,t<span class="op">=</span><span class="dv">25</span>,dim<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sphere entropies are  6.655565</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Array([0.11335707, 0.06487274, 0.05884409, 0.05740404, 0.0642314 ,
       0.06366301, 0.05483818, 0.06147385, 0.08759928, 0.05728197,
       0.06411648, 0.08686781, 0.05503988, 0.09050846, 0.08116913,
       0.03181219, 0.12897491, 0.08714104, 0.06678724, 0.05969143,
       0.07953739, 0.07100677, 0.06172848, 0.08681393, 0.07116699,
       0.09487152, 0.08594608, 0.06987953, 0.08752728, 0.08381319,
       0.10403967, 0.09759521, 0.08669853, 0.07118797, 0.05764246,
       0.09759665, 0.10303497, 0.0868988 , 0.10510015, 0.06851149,
       0.09032917, 0.07850552, 0.04110861, 0.05405045, 0.05058098,
       0.06604719, 0.10579872, 0.0817647 , 0.07427454, 0.06593466,
       0.08328724, 0.07362413, 0.09141922, 0.10187674, 0.05985785,
       0.09553814, 0.06983089, 0.04920149, 0.07766151, 0.09164715,
       0.07969284, 0.04097891, 0.0702467 , 0.06564188, 0.08948517,
       0.0845356 , 0.09049368, 0.10028028, 0.0979805 , 0.0927496 ,
       0.08528709, 0.08123779, 0.08337545, 0.06309032, 0.08763933,
       0.09051132, 0.05973339, 0.09566021, 0.06791067, 0.06535816,
       0.06742287, 0.05220127, 0.08181667, 0.07960033, 0.08837652,
       0.03656912, 0.09111023, 0.10952806, 0.05620575, 0.09327269,
       0.12839031, 0.13030815, 0.09196281, 0.07912397, 0.06233597,
       0.07339478, 0.11855936, 0.07903099, 0.09766197, 0.05419445,
       0.08125305, 0.06524277, 0.05321598, 0.08076906, 0.08762741,
       0.06943989, 0.13047361, 0.04755688, 0.08558178, 0.07583284,
       0.07408619, 0.07964134, 0.07853556, 0.08562994, 0.08383465,
       0.07005501, 0.08957243, 0.08760738, 0.10600567, 0.07975292,
       0.07248878, 0.08154964, 0.08699846, 0.11436415, 0.07627773,
       0.06837606, 0.07192278, 0.06020164, 0.10035324, 0.05051041,
       0.08448887, 0.11090851, 0.07821178, 0.09141922, 0.08282757,
       0.05962753, 0.08533669, 0.09196186, 0.06243706, 0.07434845,
       0.06517315, 0.12801504, 0.07238007, 0.08558321, 0.08384991,
       0.11973953, 0.05550003, 0.06878376, 0.07501745, 0.07222176,
       0.06437016, 0.07418203, 0.08648586, 0.07268524, 0.09285355,
       0.1021452 , 0.09206486, 0.05852842, 0.11701012, 0.09866571,
       0.06476784, 0.05934143, 0.06882191, 0.10729408, 0.08915997,
       0.07189846, 0.06034374, 0.08197355, 0.09082222, 0.07134485,
       0.09181786, 0.07562733, 0.08058929, 0.08986425, 0.10321665,
       0.08199501, 0.11547995, 0.08556461, 0.06375408, 0.09595585,
       0.07134056, 0.05936003, 0.10069847, 0.0920248 , 0.0682478 ,
       0.08965921, 0.10433626, 0.07322884, 0.09017277, 0.07954979,
       0.06465578, 0.08976555, 0.08947659, 0.10598612, 0.07743883,
       0.07683754, 0.06537199, 0.09267139, 0.09297276, 0.05983925,
       0.08270025, 0.08384848, 0.0358305 , 0.07146597, 0.05775452,
       0.06509686, 0.08713055, 0.11515236, 0.06367111, 0.05358601,
       0.07762241, 0.06050825, 0.1136961 , 0.06980181, 0.12893963,
       0.08900356, 0.06705284, 0.09195375, 0.09817123, 0.05263329,
       0.09058428, 0.06303692, 0.05026817, 0.08079863, 0.06897879,
       0.07525492, 0.08952808, 0.06900883, 0.0867424 , 0.08868504,
       0.10039949, 0.06827116, 0.05599594, 0.09328413, 0.06389952,
       0.09408426, 0.08490419, 0.0847168 , 0.10274601, 0.09403706,
       0.10481405, 0.07272911, 0.07094669, 0.07708597, 0.11218977,
       0.07840681, 0.12765694, 0.07936001, 0.06864929, 0.08695459,
       0.05975056, 0.12005091, 0.11665201, 0.08816004, 0.07531261,
       0.07729721, 0.11365318, 0.13855743, 0.07913589, 0.0781889 ,
       0.10389757, 0.12170601, 0.08514786, 0.075634  , 0.121315  ,
       0.06645107, 0.07601118, 0.060853  , 0.07239103, 0.08244514,
       0.10001373, 0.06660032, 0.06484604, 0.08138657, 0.09447384,
       0.06897068, 0.06223488, 0.09180164, 0.09990549, 0.06732178,
       0.09585047, 0.08702803, 0.06343746, 0.08570433, 0.09392262,
       0.10494709, 0.07350254, 0.05890846, 0.09878397, 0.07083607,
       0.07613325, 0.07218266, 0.08658457, 0.06997585, 0.09469509,
       0.06267452, 0.12497616, 0.08941078, 0.06324816, 0.0883131 ,
       0.10312557, 0.05045891, 0.05594158, 0.0553751 , 0.03766966,
       0.07313347, 0.07922935, 0.06505299, 0.06317997, 0.06878376,
       0.07766485, 0.09556961, 0.06594181, 0.07470226, 0.04703426,
       0.06539726, 0.06102371, 0.08212614, 0.064394  , 0.07518148,
       0.08916044, 0.07245684, 0.10277367, 0.06812429, 0.11281776,
       0.05020905, 0.12582445, 0.0698595 , 0.07491112, 0.11322117,
       0.08710861, 0.10459757, 0.07035112, 0.09850311, 0.08914948,
       0.05855513, 0.07848549, 0.07558823, 0.09352541, 0.09365845,
       0.10718155, 0.0929184 , 0.07888508, 0.05945444, 0.06639957,
       0.06795168, 0.07767439, 0.08326626, 0.06954002, 0.12832832,
       0.05132866, 0.05683613, 0.08876944, 0.08475208, 0.06815004,
       0.06830788, 0.06574154, 0.0684433 , 0.09315252, 0.06450844,
       0.08112144, 0.07032013, 0.07417583, 0.0657177 , 0.06024456,
       0.07568312, 0.06376934, 0.07691145, 0.09345627, 0.05396366,
       0.07360935, 0.06457043, 0.08803082, 0.12340546, 0.0430851 ,
       0.07584906, 0.0856905 , 0.0761919 , 0.0712986 , 0.05959988,
       0.09634113, 0.0748415 , 0.0676074 , 0.06634808, 0.10871696,
       0.08019495, 0.07570696, 0.10012627, 0.09920406, 0.10649729,
       0.06039715, 0.08942413, 0.06424427, 0.06639147, 0.0746727 ,
       0.09383821, 0.07926512, 0.0873909 , 0.08634281, 0.08192921,
       0.09456968, 0.11109734, 0.07531071, 0.04559326, 0.08145332,
       0.06811523, 0.09026051, 0.11224699, 0.06617832, 0.09417629,
       0.06792831, 0.08418083, 0.08686972, 0.12643385, 0.07878637,
       0.11114264, 0.04911709, 0.1169157 , 0.09134436, 0.08148003,
       0.09504318, 0.06370163, 0.08488941, 0.05987835, 0.13197803,
       0.05270767, 0.07995224, 0.10610676, 0.09008026, 0.06410074,
       0.06399536, 0.09253311, 0.08636713, 0.08924484, 0.12523079,
       0.06997776, 0.05615473, 0.07116127, 0.10870552, 0.07948971,
       0.08502913, 0.08753777, 0.10682964, 0.06801271, 0.08881092,
       0.0724144 , 0.07473373, 0.05977488, 0.0730381 , 0.08695221,
       0.08825588, 0.06974459, 0.0753336 , 0.09509182, 0.06197834,
       0.12962246, 0.11076736, 0.066998  , 0.08677197, 0.07073832,
       0.06846046, 0.05604649, 0.06168699, 0.09479332, 0.08106232,
       0.04374695, 0.0801959 , 0.050807  , 0.04700708, 0.09164667,
       0.10939503, 0.07735872, 0.02810955, 0.07032681, 0.07296419,
       0.07951736, 0.1094861 , 0.04912567, 0.05851364, 0.06599331,
       0.08242798, 0.07835865, 0.09446859, 0.06521273, 0.04284096,
       0.06164026, 0.05933475, 0.08355713, 0.10876608, 0.08352518,
       0.05979013, 0.09145069, 0.06964779, 0.06091166, 0.06638336,
       0.05623055, 0.0547452 , 0.06066704, 0.06565952, 0.08337498,
       0.08589268, 0.04935074, 0.05903912, 0.09692955, 0.11697578,
       0.07919025, 0.05324936, 0.07700825, 0.08991051, 0.05273294,
       0.06016684, 0.10387182, 0.06958485, 0.07950401, 0.06951571,
       0.10289955, 0.12402725, 0.09953022, 0.09806585, 0.1200881 ,
       0.06803513, 0.08253002, 0.08372974, 0.09606314, 0.1183157 ,
       0.08200359, 0.09499502, 0.12273884, 0.07668495, 0.08426666,
       0.07928753, 0.12814236, 0.09317827, 0.09383011, 0.08512974,
       0.06221008, 0.07291174, 0.06158972, 0.05036497, 0.08027458,
       0.10799599, 0.06039429, 0.0906496 , 0.12017775, 0.06580544,
       0.08006144, 0.08427143, 0.0949769 , 0.08249712, 0.06364822,
       0.07249451, 0.09234619, 0.07545185, 0.06292343, 0.09534073,
       0.0941124 , 0.06604958, 0.08753014, 0.08483124, 0.03575754,
       0.09688711, 0.08427143, 0.0531044 , 0.07679749, 0.10072041,
       0.09100342, 0.07741117, 0.11707878, 0.07924509, 0.06065083,
       0.06410646, 0.09311676, 0.08045197, 0.09255266, 0.07558632,
       0.07061768, 0.09624672, 0.06072521, 0.04834604, 0.09179211,
       0.08602047, 0.06194878, 0.1180191 , 0.08250809, 0.11218929,
       0.06011295, 0.06771755, 0.08819771, 0.08334637, 0.13812065,
       0.06575394, 0.08996582, 0.07463837, 0.13619947, 0.09487867,
       0.07237339, 0.08357668, 0.05293703, 0.1101675 , 0.09483624,
       0.06139851, 0.08657265, 0.06527901, 0.07776165, 0.08658028,
       0.06300592, 0.12784863, 0.07217884, 0.08898067, 0.05928946,
       0.07586384, 0.10997868, 0.07899761, 0.06864738, 0.07841492,
       0.09145689, 0.08152771, 0.06027985, 0.05680513, 0.10590649,
       0.05463219, 0.10816479, 0.0886116 , 0.08026123, 0.11724281,
       0.09658051, 0.09207439, 0.08112001, 0.08570385, 0.11746883,
       0.0910573 , 0.07527733, 0.07693291, 0.06337786, 0.0533123 ,
       0.09091806, 0.12636948, 0.05478144, 0.06138515, 0.04859352,
       0.06402016, 0.09357166, 0.0969696 , 0.10683918, 0.06055164,
       0.07052898, 0.09449577, 0.09978724, 0.07355452, 0.05896282,
       0.08079243, 0.07213211, 0.07021332, 0.08699036, 0.07072878,
       0.11976337, 0.09253693, 0.06851482, 0.05401516, 0.06438017,
       0.08043289, 0.07372904, 0.07995892, 0.08799839, 0.05041265,
       0.044137  , 0.09023476, 0.07026005, 0.07932806, 0.05887413,
       0.06160069, 0.1092639 , 0.06742859, 0.08018112, 0.07509518,
       0.08341551, 0.11725616, 0.06489086, 0.07964468, 0.0903883 ,
       0.13405895, 0.09177256, 0.07189655, 0.09475994, 0.06470966,
       0.07616138, 0.07341385, 0.08142757, 0.05130863, 0.1085434 ,
       0.09552002, 0.08458424, 0.06920767, 0.09314871, 0.07234097,
       0.09067297, 0.06603003, 0.06534672, 0.09344578, 0.09195995,
       0.06970596, 0.09057093, 0.0634346 , 0.07300091, 0.0798645 ,
       0.05143881, 0.07696915, 0.09007931, 0.08588409, 0.08695078,
       0.072824  , 0.08639145, 0.09895086, 0.07088995, 0.06571484,
       0.12388325, 0.08738899, 0.09012747, 0.07936764, 0.08060551,
       0.07700014, 0.09607792, 0.06435394, 0.07954502, 0.0631609 ,
       0.08287907, 0.1208849 , 0.06450367, 0.10001469, 0.12327623,
       0.05649948, 0.06689167, 0.09239864, 0.05399513, 0.07621002,
       0.08848524, 0.07452536, 0.0740881 , 0.05610752, 0.05921936,
       0.06929207, 0.09212494, 0.05885172, 0.08980083, 0.08908844,
       0.06027317, 0.09336185, 0.07325745, 0.04906607, 0.07571459,
       0.05941582, 0.06444168, 0.05993938, 0.07133055, 0.07237768,
       0.08626509, 0.09695721, 0.08766174, 0.07289362, 0.05293512,
       0.04969406, 0.05608368, 0.09086418, 0.10088253, 0.0633564 ,
       0.09067631, 0.08647251, 0.08081388, 0.05587864, 0.08291006,
       0.08054352, 0.11178827, 0.10813284, 0.07212782, 0.10191488,
       0.07481098, 0.08961678, 0.07601929, 0.07112312, 0.0625639 ,
       0.09436321, 0.05116749, 0.09538364, 0.09458685, 0.08861494,
       0.07372522, 0.06473398, 0.10284948, 0.07118034, 0.05463266,
       0.05225754, 0.05532551, 0.06560755, 0.05490637, 0.12158346,
       0.09354687, 0.0847435 , 0.130579  , 0.07846737, 0.06517935,
       0.08480835, 0.06446791, 0.08926773, 0.07934189, 0.07303619,
       0.0624814 , 0.07749367, 0.08417702, 0.08885288, 0.06671333,
       0.0852232 , 0.05438328, 0.06187677, 0.09126759, 0.06946278,
       0.03325844, 0.07932758, 0.08590794, 0.06253338, 0.0816927 ,
       0.09391689, 0.1122179 , 0.08875847, 0.07191372, 0.09672832,
       0.0823431 , 0.05952024, 0.051054  , 0.10187626, 0.06600952,
       0.08030128, 0.13138914, 0.09526825, 0.06717682, 0.04946089,
       0.08749104, 0.13514328, 0.06309128, 0.05427265, 0.08188057,
       0.10002708, 0.09151554, 0.08147621, 0.09595966, 0.0814786 ,
       0.08463001, 0.09094143, 0.076087  , 0.06060266, 0.08299351,
       0.09974241, 0.08121109, 0.07871056, 0.03160238, 0.04907417,
       0.08376646, 0.06574059, 0.09810638, 0.06866074, 0.0599823 ,
       0.0912447 , 0.07961941, 0.0949831 , 0.08458138, 0.110888  ,
       0.0887146 , 0.05327415, 0.08838749, 0.06019258, 0.06787682,
       0.07150173, 0.06150913, 0.08768463, 0.09446049, 0.07628107,
       0.0777607 , 0.09572411, 0.11461926, 0.06961966, 0.04371357,
       0.10290718, 0.07389641, 0.11757326, 0.08449745, 0.09725189,
       0.06266117, 0.09806252, 0.0629673 , 0.10153055, 0.08573723,
       0.07448578, 0.0763731 , 0.07483196, 0.07042503, 0.08677483,
       0.08396435, 0.11277103, 0.09647322, 0.06644011, 0.12908268,
       0.06702042, 0.09411621, 0.06900978, 0.08332348, 0.07097864,
       0.10585499, 0.05586147, 0.07631302, 0.05942869, 0.06037331,
       0.0894084 , 0.08821344, 0.11110973, 0.04807377, 0.08792496,
       0.0760746 , 0.06967068, 0.08922672, 0.028965  , 0.08651161,
       0.08542585, 0.09427595, 0.08531189, 0.10176229, 0.09003162,
       0.12104511, 0.07161331, 0.07312965, 0.10148144, 0.08242655,
       0.0694809 , 0.06045151, 0.06627083, 0.09000969, 0.09677505,
       0.08189869, 0.1018281 , 0.06925154, 0.09970713, 0.11207676,
       0.06885433, 0.05326128, 0.06263638, 0.07164431, 0.07298803,
       0.07818079, 0.11038685, 0.08878708, 0.07209206, 0.06343794,
       0.10221481, 0.06774139, 0.08673811, 0.03009081, 0.05997753,
       0.06807661, 0.08285809, 0.03423882, 0.08674049, 0.09929848,
       0.04765987, 0.07797718, 0.06278992, 0.11527443, 0.08953571,
       0.09015942, 0.08607244, 0.08385897, 0.07640123, 0.06941175,
       0.0920949 , 0.0824852 , 0.08013582, 0.10355186, 0.08541107,
       0.10334301, 0.06365776, 0.07396507, 0.08944321, 0.06364107,
       0.06188726, 0.05822945, 0.09568787, 0.13042402, 0.07145357,
       0.08201027, 0.10353804, 0.09361458, 0.08052015, 0.09439564,
       0.07261038, 0.08382034, 0.08790207, 0.05024719, 0.06147575,
       0.11889267, 0.08236313, 0.0749197 , 0.07372189, 0.09831762],      dtype=float32)</code></pre>
</div>
</div>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>X_plane <span class="op">=</span> plane(<span class="bu">len</span>(X_sphere))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>G_plane <span class="op">=</span> get_adaptive_graph(X_plane)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>plane_entropy <span class="op">=</span> DC.unsigned_curvature(G_plane, t<span class="op">=</span><span class="dv">25</span>)[<span class="dv">0</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Plane entropy is "</span>, plane_entropy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Plane entropy is  6.802491</code></pre>
</div>
</div>
</section>
<section id="on-the-plane" class="level2">
<h2 class="anchored" data-anchor-id="on-the-plane">On the Plane</h2>
<div id="cell-25" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>X_plane <span class="op">=</span> plane(<span class="dv">1000</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>G_plane <span class="op">=</span> get_adaptive_graph(X_plane) <span class="co">#get_alpha_decay_graph(X_plane, decay=None, knn=15, anisotropy=1, )</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> diffusion_matrix_from_affinities(G_plane.W) <span class="co">#diff_op(G_plane).todense() # is sparse, by default</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> jnp.array(P)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>Pt <span class="op">=</span> jax_power_matrix(P,<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the first scatter plot</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].scatter(X_plane[:,<span class="dv">0</span>],X_plane[:,<span class="dv">1</span>],c<span class="op">=</span>P[<span class="dv">0</span>].tolist(), cmap<span class="op">=</span><span class="st">'jet'</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">0</span>].set_title(<span class="st">'Diffusion P'</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the second scatter plot</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].scatter(X_plane[:,<span class="dv">0</span>],X_plane[:,<span class="dv">1</span>],c<span class="op">=</span>Pt[<span class="dv">0</span>].tolist(), cmap<span class="op">=</span><span class="st">'jet'</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>axs[<span class="dv">1</span>].set_title(<span class="st">'Diffusion Pt'</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-27" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,points_per_cluster<span class="op">=</span><span class="va">None</span>,comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>, flattening_method<span class="op">=</span><span class="st">"Fixed"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ks_plane<span class="op">=</span> DC.curvature(G_plane, t<span class="op">=</span><span class="dv">8</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check that higher dimensional planes are also given flat curvature</p>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> [<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>planes <span class="op">=</span> [plane(<span class="dv">1000</span><span class="op">*</span><span class="dv">2</span><span class="op">**</span>(d<span class="op">-</span><span class="dv">2</span>), d) <span class="cf">for</span> d <span class="kw">in</span> ds]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(ds):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> get_adaptive_graph(planes[i]) <span class="co">#get_alpha_decay_graph(planes[i], decay=None, knn=15, anisotropy=1, )</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    DC <span class="op">=</span> DiffusionCurvature(laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,points_per_cluster<span class="op">=</span><span class="dv">500</span>,comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>, flattening_method<span class="op">=</span><span class="st">"Fixed"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    ks <span class="op">=</span> DC.curvature(G, t<span class="op">=</span><span class="dv">8</span>, dim<span class="op">=</span>d, knn<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"dimension"</span>,d,<span class="st">": Curvature of Plane is "</span>,ks[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dimension 3 : Curvature of Plane is  0.0050811768
dimension 4 : Curvature of Plane is  -0.0046873093
dimension 5 : Curvature of Plane is  -0.000705719</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-03 19:46:52.845911: W external/tsl/tsl/framework/bfc_allocator.cc:485] Allocator (GPU_0_bfc) ran out of memory trying to allocate 976.68MiB (rounded to 1024128256)requested by op 
2024-01-03 19:46:52.846067: W external/tsl/tsl/framework/bfc_allocator.cc:497] ************************************************xx_____*************______________________________**
2024-01-03 19:46:52.846137: E external/xla/xla/pjrt/pjrt_stream_executor_client.cc:2716] Execution of replica 0 failed: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 1024128004 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:    1.91GiB
              constant allocation:         0B
        maybe_live_out allocation:  976.68MiB
     preallocated temp allocation:         0B
                 total allocation:    2.86GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 976.68MiB
        Entry Parameter Subshape: f32[16001,16001]
        ==========================

    Buffer 2:
        Size: 976.68MiB
        Entry Parameter Subshape: f32[16001,16001]
        ==========================

    Buffer 3:
        Size: 976.68MiB
        Operator: op_name="jit(fn)/jit(main)/add" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/graphs.py" source_line=131
        XLA Label: fusion
        Shape: f32[16001,16001]
        ==========================

</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>XlaRuntimeError: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 1024128004 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:    1.91GiB
              constant allocation:         0B
        maybe_live_out allocation:  976.68MiB
     preallocated temp allocation:         0B
                 total allocation:    2.86GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 976.68MiB
        Entry Parameter Subshape: f32[16001,16001]
        ==========================

    Buffer 2:
        Size: 976.68MiB
        Entry Parameter Subshape: f32[16001,16001]
        ==========================

    Buffer 3:
        Size: 976.68MiB
        Operator: op_name="jit(fn)/jit(main)/add" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/graphs.py" source_line=131
        XLA Label: fusion
        Shape: f32[16001,16001]
        ==========================
</code></pre>
</div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> [<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>planes <span class="op">=</span> [plane(<span class="dv">1000</span><span class="op">*</span><span class="dv">2</span><span class="op">**</span>(d<span class="op">-</span><span class="dv">2</span>), d) <span class="cf">for</span> d <span class="kw">in</span> ds]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(ds):</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> get_adaptive_graph(planes[i]) <span class="co">#get_alpha_decay_graph(planes[i], decay=None, knn=15, anisotropy=1, )</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    DC <span class="op">=</span> DiffusionCurvature(laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,points_per_cluster<span class="op">=</span><span class="va">None</span>,comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>, flattening_method<span class="op">=</span><span class="st">"Fixed"</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    ks <span class="op">=</span> DC.curvature(G, t<span class="op">=</span><span class="dv">8</span>, dim<span class="op">=</span>d, knn<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"dimension"</span>,d,<span class="st">": Curvature of Plane is "</span>,ks[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="how-bout-a-donut" class="level2">
<h2 class="anchored" data-anchor-id="how-bout-a-donut">How bout a donut?</h2>
<section id="with-entropic-subtraction-fixed-flattening" class="level3">
<h3 class="anchored" data-anchor-id="with-entropic-subtraction-fixed-flattening">With Entropic, Subtraction, Fixed Flattening</h3>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>X_torus,ks <span class="op">=</span> torus(<span class="dv">5000</span>,use_guide_points<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>G_torus <span class="op">=</span> get_adaptive_graph(X_torus) <span class="co">#graphtools.Graph(X_torus, anisotropy=1, knn=15, decay=None).to_pygsp()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:04:18,896:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">30</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:04:24,962:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-25-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-36" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Text(0, 0.5, 'Diffusion Curvature')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-26-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="with-wasserstein-subtraction-fixed-flattening" class="level3">
<h3 class="anchored" data-anchor-id="with-wasserstein-subtraction-fixed-flattening">With Wasserstein, Subtraction, Fixed Flattening</h3>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>X_torus,ks <span class="op">=</span> torus(<span class="dv">5000</span>,use_guide_points<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>G_torus <span class="op">=</span> get_adaptive_graph(X_torus) <span class="co">#graphtools.Graph(X_torus, anisotropy=1, knn=15, decay=None).to_pygsp()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:06:20,768:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Wasserstein"</span>,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">30</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:06:35.055675: W external/tsl/tsl/framework/bfc_allocator.cc:485] Allocator (GPU_0_bfc) ran out of memory trying to allocate 465.66GiB (rounded to 500000000000)requested by op 
2024-01-19 10:06:35.055807: W external/tsl/tsl/framework/bfc_allocator.cc:497] *********__________________________________________________________________________________________*
2024-01-19 10:06:35.055878: E external/xla/xla/pjrt/pjrt_stream_executor_client.cc:2716] Execution of replica 0 failed: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 500000000000 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:  190.73MiB
              constant allocation:         0B
        maybe_live_out allocation:  465.66GiB
     preallocated temp allocation:         0B
                 total allocation:  465.85GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 465.66GiB
        Operator: op_name="jit(&lt;lambda&gt;)/jit(main)/sub" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/distances.py" source_line=30
        XLA Label: fusion
        Shape: f32[5000,5000,5000]
        ==========================

    Buffer 2:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[5000,1,5000]
        ==========================

    Buffer 3:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[1,5000,5000]
        ==========================

</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>XlaRuntimeError: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 500000000000 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:  190.73MiB
              constant allocation:         0B
        maybe_live_out allocation:  465.66GiB
     preallocated temp allocation:         0B
                 total allocation:  465.85GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 465.66GiB
        Operator: op_name="jit(&lt;lambda&gt;)/jit(main)/sub" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/distances.py" source_line=30
        XLA Label: fusion
        Shape: f32[5000,5000,5000]
        ==========================

    Buffer 2:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[5000,1,5000]
        ==========================

    Buffer 3:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[1,5000,5000]
        ==========================
</code></pre>
</div>
</div>
<div id="cell-40" class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-29-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Text(0, 0.5, 'Diffusion Curvature')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="with-grid" class="level3">
<h3 class="anchored" data-anchor-id="with-grid">With Grid</h3>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    use_grid<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">25</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-45" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-wasserstein" class="level3">
<h3 class="anchored" data-anchor-id="with-wasserstein">With Wasserstein</h3>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>X_torus, ks_true <span class="op">=</span> torus(<span class="dv">5000</span>,use_guide_points<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>G_torus <span class="op">=</span> get_adaptive_graph(X_torus)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Wasserstein"</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Ollivier"</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">15</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-19 10:01:16,929:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!
2024-01-19 10:01:27.627155: W external/tsl/tsl/framework/bfc_allocator.cc:485] Allocator (GPU_0_bfc) ran out of memory trying to allocate 465.66GiB (rounded to 500000000000)requested by op 
2024-01-19 10:01:27.627302: W external/tsl/tsl/framework/bfc_allocator.cc:497] ******_____________________________________________________________________________________________*
2024-01-19 10:01:27.627368: E external/xla/xla/pjrt/pjrt_stream_executor_client.cc:2716] Execution of replica 0 failed: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 500000000000 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:  190.73MiB
              constant allocation:         0B
        maybe_live_out allocation:  465.66GiB
     preallocated temp allocation:         0B
                 total allocation:  465.85GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 465.66GiB
        Operator: op_name="jit(&lt;lambda&gt;)/jit(main)/sub" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/distances.py" source_line=30
        XLA Label: fusion
        Shape: f32[5000,5000,5000]
        ==========================

    Buffer 2:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[5000,1,5000]
        ==========================

    Buffer 3:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[1,5000,5000]
        ==========================

</code></pre>
</div>
<div class="cell-output cell-output-error">
<pre><code>XlaRuntimeError: RESOURCE_EXHAUSTED: Out of memory while trying to allocate 500000000000 bytes.
BufferAssignment OOM Debugging.
BufferAssignment stats:
             parameter allocation:  190.73MiB
              constant allocation:         0B
        maybe_live_out allocation:  465.66GiB
     preallocated temp allocation:         0B
                 total allocation:  465.85GiB
              total fragmentation:         0B (0.00%)
Peak buffers:
    Buffer 1:
        Size: 465.66GiB
        Operator: op_name="jit(&lt;lambda&gt;)/jit(main)/sub" source_file="/home/piriac/Pumberton/Workshop/21-SUMRY-Curvature/diffusion_curvature/diffusion_curvature/distances.py" source_line=30
        XLA Label: fusion
        Shape: f32[5000,5000,5000]
        ==========================

    Buffer 2:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[5000,1,5000]
        ==========================

    Buffer 3:
        Size: 95.37MiB
        Entry Parameter Subshape: f32[1,5000,5000]
        ==========================
</code></pre>
</div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Wasserstein Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: 'c' argument has 1000 elements, which is inconsistent with 'x' and 'y' with size 5000.</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-35-output-2.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>ValueError: x and y must be the same size</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-36-output-2.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-50" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-laziness" class="level3">
<h3 class="anchored" data-anchor-id="with-laziness">With Laziness</h3>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> graph_from_gaussian_kernel(X, sigma <span class="op">=</span> <span class="dv">0</span>, alpha <span class="op">=</span> <span class="dv">0</span>):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> gaussian_kernel(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        X,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        kernel_type<span class="op">=</span><span class="st">'fixed'</span>,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> sigma, <span class="co"># use median heuristic</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        anisotropic_density_normalization <span class="op">=</span> alpha,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> SimpleGraph(W <span class="op">=</span> W)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> G</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Laziness"</span>,</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    aperture<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    smoothing <span class="op">=</span> <span class="dv">1</span>,</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    graph_former <span class="op">=</span> partial(graph_from_gaussian_kernel, sigma<span class="op">=</span><span class="fl">0.05</span>),</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">30</span>, dim<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>uks <span class="op">=</span> DC.unsigned_curvature(G_torus,t<span class="op">=</span><span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-57" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,DC.P[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Laziness Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-44-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,uks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-45-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-vne-t-selection" class="level3">
<h3 class="anchored" data-anchor-id="with-vne-t-selection">With VNE t selection</h3>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    use_grid<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="va">None</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'scipy.sparse._csr.csr_matrix'&gt;
(1000,)
&lt;class 'scipy.sparse._csr.csr_matrix'&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2024-01-03 20:44:48,884:[WARNING](pygsp.graphs.graph.check_weights): The main diagonal of the weight matrix is not 0!</code></pre>
</div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Core_files/figure-html/cell-48-output-1.png" class="img-fluid"></p>
</div>
</div>
<div id="cell-64" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-neural-flattening" class="level3">
<h3 class="anchored" data-anchor-id="with-neural-flattening">With Neural Flattening</h3>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Neural"</span>,</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="dv">100</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    max_flattening_epochs<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    use_grid<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">25</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-67" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Fixed"</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>ks_torus_at_idx <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">15</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>, idx<span class="op">=</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>ks_torus_at_idx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>uks <span class="op">=</span> DC.unsigned_curvature(G_torus,t<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>uks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,uks,colorbar<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> enhanced_spectral_clustering(G_torus, uks, dim<span class="op">=</span><span class="dv">2</span>, num_clusters<span class="op">=</span><span class="dv">9</span>, )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,labels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-76" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>entropy_of_diffusion(Pt[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>fakePt <span class="op">=</span> jnp.concatenate([Pt[<span class="dv">0</span>], jnp.zeros(<span class="bu">len</span>(Pt[<span class="dv">0</span>]))])</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>entropy_of_diffusion(jnp.concatenate([Pt[<span class="dv">0</span>], jnp.zeros(<span class="bu">len</span>(Pt[<span class="dv">0</span>]))]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-78" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>jax.scipy.special.entr(jnp.concatenate([Pt[<span class="dv">0</span>], jnp.zeros(<span class="bu">len</span>(Pt[<span class="dv">0</span>]))]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get num nonzero entries in fakePt</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>jnp.<span class="bu">sum</span>(fakePt<span class="op">&gt;</span><span class="fl">1e-10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-80" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(<span class="op">-</span>jnp.log(<span class="dv">1</span><span class="op">/</span>jnp.<span class="bu">sum</span>(fakePt<span class="op">&gt;</span><span class="fl">1e-10</span>, axis<span class="op">=-</span><span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-81" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>jnp.<span class="bu">sum</span>(jax.scipy.special.entr(jnp.ones(<span class="dv">10</span>)<span class="op">/</span><span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="with-mean-flattening" class="level3">
<h3 class="anchored" data-anchor-id="with-mean-flattening">With Mean Flattening</h3>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>DC <span class="op">=</span> DiffusionCurvature(</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    laziness_method<span class="op">=</span><span class="st">"Entropic"</span>,</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    flattening_method<span class="op">=</span><span class="st">"Mean Fixed"</span>,</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    comparison_method<span class="op">=</span><span class="st">"Subtraction"</span>,</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    points_per_cluster<span class="op">=</span><span class="va">None</span>, <span class="co"># construct separate comparison spaces around each point</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    comparison_space_size_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>    use_grid<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>ks_torus <span class="op">=</span> DC.curvature(G_torus, t<span class="op">=</span><span class="dv">25</span>, dim<span class="op">=</span><span class="dv">2</span>, knn<span class="op">=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>plot_3d(X_torus,ks_torus,colorbar<span class="op">=</span><span class="va">True</span>,title<span class="op">=</span><span class="st">'Diffusion Comparison Curvature of the Torus'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-85" class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(ks, ks_torus)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Diffusion Curvature vs Real Curvature of Torus"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Gaussian Curvature"</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Diffusion Curvature"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-86" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>nbdev_export</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>